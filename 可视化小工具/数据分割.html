<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–åˆ†å‰²å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #34495e;
        }
        
        .upload-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .file-info {
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .series-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .series-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .series-btn.active {
            background: #e3f2fd;
            border-color: #3498db;
            color: #2980b9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .chart-wrapper {
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #555;
        }
        
        .range-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .export-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .help-text {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        #fileInput {
            display: none;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–åˆ†å‰²å·¥å…·</h1>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="card">
            <h2>ä¸Šä¼ æ•°æ®æ–‡ä»¶</h2>
            <div class="upload-area">
                <div>
                    <p class="help-text">æ”¯æŒåŒ…å«ä¼ æ„Ÿå™¨æ•°æ®çš„TXTæˆ–CSVæ–‡ä»¶</p>
                </div>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <span class="icon">ğŸ“</span>
                    é€‰æ‹©æ–‡ä»¶
                </button>
                <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileUpload(event)">
            </div>
            <div id="fileInfo" class="file-info hidden"></div>
        </div>
        
        <!-- æ•°æ®ç³»åˆ—é€‰æ‹©å™¨ -->
        <div id="seriesSelector" class="card hidden">
            <h2>é€‰æ‹©æ˜¾ç¤ºçš„æ•°æ®ç³»åˆ—</h2>
            <div class="series-controls">
                <button class="series-btn active" data-series="acceleration">åŠ é€Ÿåº¦</button>
                <button class="series-btn active" data-series="gyroscope">è§’é€Ÿåº¦</button>
                <button class="series-btn active" data-series="angle">è§’åº¦</button>
                <button class="series-btn" data-series="magnetic">ç£åœº</button>
                <button class="series-btn" data-series="quaternion">å››å…ƒæ•°</button>
                <button class="series-btn" data-series="temperature">æ¸©åº¦</button>
            </div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div id="chartsArea" class="card hidden">
            <h2>æ•°æ®å›¾è¡¨ <span class="help-text">(æ‹–åŠ¨é¼ æ ‡é€‰æ‹©æ•°æ®èŒƒå›´)</span></h2>
            
            <div id="accelerationChart" class="chart-wrapper">
                <h3 class="chart-title">åŠ é€Ÿåº¦ (g)</h3>
                <div class="chart-container">
                    <canvas id="accelCanvas"></canvas>
                </div>
            </div>
            
            <div id="gyroscopeChart" class="chart-wrapper">
                <h3 class="chart-title">è§’é€Ÿåº¦ (Â°/s)</h3>
                <div class="chart-container">
                    <canvas id="gyroCanvas"></canvas>
                </div>
            </div>
            
            <div id="angleChart" class="chart-wrapper">
                <h3 class="chart-title">è§’åº¦ (Â°)</h3>
                <div class="chart-container">
                    <canvas id="angleCanvas"></canvas>
                </div>
            </div>
            
            <div id="magneticChart" class="chart-wrapper hidden">
                <h3 class="chart-title">ç£åœº (uT)</h3>
                <div class="chart-container">
                    <canvas id="magneticCanvas"></canvas>
                </div>
            </div>
            
            <div id="quaternionChart" class="chart-wrapper hidden">
                <h3 class="chart-title">å››å…ƒæ•°</h3>
                <div class="chart-container">
                    <canvas id="quaternionCanvas"></canvas>
                </div>
            </div>
            
            <div id="temperatureChart" class="chart-wrapper hidden">
                <h3 class="chart-title">æ¸©åº¦ (Â°C)</h3>
                <div class="chart-container">
                    <canvas id="tempCanvas"></canvas>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®åˆ†å‰²å’Œå¯¼å‡ºåŒºåŸŸ -->
        <div id="exportArea" class="card hidden">
            <h2>æ•°æ®åˆ†å‰²å’Œå¯¼å‡º</h2>
            <div id="rangeInfo" class="range-info hidden"></div>
            <div id="exportControls" class="export-controls">
                <button class="btn btn-success" onclick="exportData('txt')">
                    <span class="icon">ğŸ’¾</span>
                    å¯¼å‡ºä¸º TXT
                </button>
                <button class="btn btn-primary" onclick="exportData('csv')">
                    <span class="icon">ğŸ’¾</span>
                    å¯¼å‡ºä¸º CSV
                </button>
                <button class="btn btn-secondary" onclick="clearSelection()">
                    <span class="icon">âœ‚ï¸</span>
                    æ¸…é™¤é€‰æ‹©
                </button>
            </div>
            <p id="noSelectionText" class="help-text">è¯·åœ¨å›¾è¡¨ä¸Šæ‹–åŠ¨é¼ æ ‡é€‰æ‹©è¦åˆ†å‰²çš„æ•°æ®èŒƒå›´</p>
        </div>
    </div>

    <script>
        let rawData = [];
        let fileName = '';
        let charts = {};
        let selectedRange = { start: null, end: null };
        let isSelecting = false;
        let selectingChart = null;
        
        // æ•°æ®ç³»åˆ—æ˜ å°„
        const seriesMap = {
            acceleration: ['åŠ é€Ÿåº¦X', 'åŠ é€Ÿåº¦Y', 'åŠ é€Ÿåº¦Z'],
            gyroscope: ['è§’é€Ÿåº¦X', 'è§’é€Ÿåº¦Y', 'è§’é€Ÿåº¦Z'],
            angle: ['è§’åº¦X', 'è§’åº¦Y', 'è§’åº¦Z'],
            magnetic: ['ç£åœºX', 'ç£åœºY', 'ç£åœºZ'],
            quaternion: ['å››å…ƒæ•°0', 'å››å…ƒæ•°1', 'å››å…ƒæ•°2', 'å››å…ƒæ•°3'],
            temperature: ['æ¸©åº¦']
        };
        
        // å›¾è¡¨é¢œè‰²
        const colors = {
            x: 'rgb(54, 162, 235)',
            y: 'rgb(75, 192, 192)',
            z: 'rgb(255, 159, 64)',
            single: 'rgb(255, 99, 132)',
            quaternion: ['rgb(153, 102, 255)', 'rgb(255, 205, 86)', 'rgb(255, 99, 132)', 'rgb(54, 162, 235)']
        };
        
        // è§£ææ•°æ®æ–‡ä»¶
        function parseDataFile(content) {
            const lines = content.trim().split('\n');
            const headers = lines[0].split('\t');
            
            const data = lines.slice(1).map((line, index) => {
                const values = line.split('\t');
                const row = { _index: index };
                
                headers.forEach((header, i) => {
                    if (header === 'æ—¶é—´') {
                        row.time = values[i];
                    } else if (header === 'è®¾å¤‡åç§°') {
                        row.device = values[i];
                    } else {
                        const match = header.match(/(.+)\((.+)\)/);
                        if (match) {
                            const [, name] = match;
                            row[name] = parseFloat(values[i]) || 0;
                        }
                    }
                });
                
                return row;
            });
            
            return data;
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            fileName = file.name;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const content = e.target.result;
                rawData = parseDataFile(content);
                
                // æ›´æ–°UI
                document.getElementById('fileInfo').innerHTML = 
                    'å½“å‰æ–‡ä»¶ï¼š<strong>' + fileName + '</strong> | æ•°æ®ç‚¹æ•°ï¼š<strong>' + rawData.length + '</strong>';
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('seriesSelector').classList.remove('hidden');
                document.getElementById('chartsArea').classList.remove('hidden');
                document.getElementById('exportArea').classList.remove('hidden');
                
                // åˆå§‹åŒ–å›¾è¡¨
                initCharts();
                updateCharts();
            };
            
            reader.readAsText(file);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // åˆ›å»ºåŠ é€Ÿåº¦å›¾è¡¨
            charts.acceleration = createChart('accelCanvas', seriesMap.acceleration, 
                [colors.x, colors.y, colors.z]);
            
            // åˆ›å»ºè§’é€Ÿåº¦å›¾è¡¨
            charts.gyroscope = createChart('gyroCanvas', seriesMap.gyroscope, 
                [colors.x, colors.y, colors.z]);
            
            // åˆ›å»ºè§’åº¦å›¾è¡¨
            charts.angle = createChart('angleCanvas', seriesMap.angle, 
                [colors.x, colors.y, colors.z]);
            
            // åˆ›å»ºç£åœºå›¾è¡¨
            charts.magnetic = createChart('magneticCanvas', seriesMap.magnetic, 
                [colors.x, colors.y, colors.z]);
            
            // åˆ›å»ºå››å…ƒæ•°å›¾è¡¨
            charts.quaternion = createChart('quaternionCanvas', seriesMap.quaternion, 
                colors.quaternion);
            
            // åˆ›å»ºæ¸©åº¦å›¾è¡¨
            charts.temperature = createChart('tempCanvas', seriesMap.temperature, 
                [colors.single]);
        }
        
        // åˆ›å»ºå•ä¸ªå›¾è¡¨
        function createChart(canvasId, dataKeys, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const datasets = dataKeys.map((key, index) => ({
                label: key,
                data: rawData.map(row => row[key]),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.1
            }));
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rawData.map((_, i) => i),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return 'ç´¢å¼•: ' + index + ' | æ—¶é—´: ' + (rawData[index].time || '');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ•°æ®ç´¢å¼•'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'å€¼'
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
            
            // æ·»åŠ äº¤äº’äº‹ä»¶
            const canvas = document.getElementById(canvasId);
            canvas.addEventListener('mousedown', (e) => handleMouseDown(e, chart, canvasId));
            canvas.addEventListener('mousemove', (e) => handleMouseMove(e, chart));
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            
            return chart;
        }
        
        // é¼ æ ‡äº‹ä»¶å¤„ç†
        function handleMouseDown(event, chart, chartId) {
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
            
            if (dataX >= 0 && dataX < rawData.length) {
                isSelecting = true;
                selectingChart = chartId;
                selectedRange.start = Math.round(dataX);
                selectedRange.end = Math.round(dataX);
                updateSelection();
            }
        }
        
        function handleMouseMove(event, chart) {
            if (!isSelecting) return;
            
            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
            
            if (dataX >= 0 && dataX < rawData.length) {
                selectedRange.end = Math.round(dataX);
                updateSelection();
            }
        }
        
        function handleMouseUp() {
            isSelecting = false;
            selectingChart = null;
        }
        
        // æ›´æ–°é€‰æ‹©åŒºåŸŸ
        function updateSelection() {
            // æ›´æ–°æ‰€æœ‰å›¾è¡¨çš„èƒŒæ™¯è‰²æ¥æ˜¾ç¤ºé€‰æ‹©åŒºåŸŸ
            Object.entries(charts).forEach(([key, chart]) => {
                const dataset = chart.data.datasets[0];
                if (!dataset) return;
                
                const backgroundColor = new Array(rawData.length);
                const start = Math.min(selectedRange.start, selectedRange.end);
                const end = Math.max(selectedRange.start, selectedRange.end);
                
                for (let i = 0; i < rawData.length; i++) {
                    if (i >= start && i <= end) {
                        backgroundColor[i] = 'rgba(54, 162, 235, 0.2)';
                    } else {
                        backgroundColor[i] = 'transparent';
                    }
                }
                
                // æ›´æ–°æ‰€æœ‰æ•°æ®é›†çš„èƒŒæ™¯è‰²
                chart.data.datasets.forEach(ds => {
                    ds.backgroundColor = backgroundColor;
                });
                
                chart.update('none');
            });
            
            // æ›´æ–°èŒƒå›´ä¿¡æ¯
            updateRangeInfo();
        }
        
        // æ›´æ–°èŒƒå›´ä¿¡æ¯
        function updateRangeInfo() {
            const rangeInfo = document.getElementById('rangeInfo');
            const noSelectionText = document.getElementById('noSelectionText');
            
            if (selectedRange.start !== null && selectedRange.end !== null) {
                const start = Math.min(selectedRange.start, selectedRange.end);
                const end = Math.max(selectedRange.start, selectedRange.end);
                const count = end - start + 1;
                
                rangeInfo.innerHTML = 
                    'å·²é€‰æ‹©æ•°æ®èŒƒå›´ï¼šç´¢å¼• <strong>' + start + '</strong> åˆ° <strong>' + end + '</strong>' +
                    '<span style="margin-left: 10px;">(å…± <strong>' + count + '</strong> ä¸ªæ•°æ®ç‚¹)</span>';
                rangeInfo.classList.remove('hidden');
                noSelectionText.classList.add('hidden');
            } else {
                rangeInfo.classList.add('hidden');
                noSelectionText.classList.remove('hidden');
            }
        }
        
        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            selectedRange = { start: null, end: null };
            
            // æ¸…é™¤æ‰€æœ‰å›¾è¡¨çš„èƒŒæ™¯è‰²
            Object.values(charts).forEach(chart => {
                chart.data.datasets.forEach(ds => {
                    ds.backgroundColor = 'transparent';
                });
                chart.update('none');
            });
            
            updateRangeInfo();
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData(format) {
            if (selectedRange.start === null || selectedRange.end === null) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ•°æ®èŒƒå›´');
                return;
            }
            
            const start = Math.min(selectedRange.start, selectedRange.end);
            const end = Math.max(selectedRange.start, selectedRange.end);
            const selectedData = rawData.slice(start, end + 1);
            
            let content = '';
            
            if (format === 'csv') {
                // CSVæ ¼å¼
                const headers = Object.keys(selectedData[0]).filter(key => key !== '_index');
                content = headers.join(',') + '\n';
                selectedData.forEach(row => {
                    content += headers.map(header => row[header] || '').join(',') + '\n';
                });
            } else {
                // TXTæ ¼å¼ï¼ˆåŸå§‹æ ¼å¼ï¼‰
                const headerMap = {
                    'time': 'æ—¶é—´',
                    'device': 'è®¾å¤‡åç§°',
                    'åŠ é€Ÿåº¦X': 'åŠ é€Ÿåº¦X(g)',
                    'åŠ é€Ÿåº¦Y': 'åŠ é€Ÿåº¦Y(g)',
                    'åŠ é€Ÿåº¦Z': 'åŠ é€Ÿåº¦Z(g)',
                    'è§’é€Ÿåº¦X': 'è§’é€Ÿåº¦X(Â°/s)',
                    'è§’é€Ÿåº¦Y': 'è§’é€Ÿåº¦Y(Â°/s)',
                    'è§’é€Ÿåº¦Z': 'è§’é€Ÿåº¦Z(Â°/s)',
                    'è§’åº¦X': 'è§’åº¦X(Â°)',
                    'è§’åº¦Y': 'è§’åº¦Y(Â°)',
                    'è§’åº¦Z': 'è§’åº¦Z(Â°)',
                    'ç£åœºX': 'ç£åœºX(uT)',
                    'ç£åœºY': 'ç£åœºY(uT)',
                    'ç£åœºZ': 'ç£åœºZ(uT)',
                    'å››å…ƒæ•°0': 'å››å…ƒæ•°0()',
                    'å››å…ƒæ•°1': 'å››å…ƒæ•°1()',
                    'å››å…ƒæ•°2': 'å››å…ƒæ•°2()',
                    'å››å…ƒæ•°3': 'å››å…ƒæ•°3()',
                    'æ¸©åº¦': 'æ¸©åº¦(Â°C)',
                    'ç‰ˆæœ¬å·': 'ç‰ˆæœ¬å·()',
                    'ç”µé‡': 'ç”µé‡(%)'
                };
                
                const headers = Object.keys(selectedData[0]).filter(key => key !== '_index');
                const txtHeaders = headers.map(h => headerMap[h] || h);
                content = txtHeaders.join('\t') + '\n';
                selectedData.forEach(row => {
                    content += headers.map(header => row[header] || '').join('\t') + '\n';
                });
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.split('.')[0] + '_split_' + new Date().getTime() + '.' + format;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // æ•°æ®ç³»åˆ—åˆ‡æ¢
        document.querySelectorAll('.series-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
                const series = this.dataset.series;
                const chartWrapper = document.getElementById(series + 'Chart');
                
                if (this.classList.contains('active')) {
                    chartWrapper.classList.remove('hidden');
                } else {
                    chartWrapper.classList.add('hidden');
                }
            });
        });
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateCharts() {
            Object.values(charts).forEach(chart => {
                chart.update();
            });
        }
    </script>
</body>
</html>