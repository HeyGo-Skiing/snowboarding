<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMU-é´å­å§¿æ€å¯è§†åŒ–å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        .slider-controls {
            margin-top: 15px;
        }
        .slider-group {
            margin-bottom: 15px;
        }
        .slider-group label {
            display: block;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            cursor: pointer;
            border-radius: 3px;
        }
        .slider-group input[type="range"]:hover {
            opacity: 1;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .right-panel {
            width: 400px;
            padding: 20px;
            background: white;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        .viewer-container {
            flex: 1;
            position: relative;
            border-bottom: 1px solid #ddd;
        }
        .viewer-title {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 600;
            z-index: 100;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-direction: column;
            width: 80%;
            max-width: 600px;
        }
        .button-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .slider-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .time-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .time-slider:hover {
            opacity: 1;
        }
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
        }
        .time-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 18px;
        }
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            width: 100%;
            background: white;
            margin-bottom: 10px;
        }
        .transform-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        .input-group input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }
        .info-item {
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .info-label {
            color: #7f8c8d;
            font-size: 12px;
        }
        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }
        .chart-container {
            height: 250px;
            margin-top: 15px;
        }
        .time-display {
            font-family: monospace;
            font-size: 16px;
            color: #2c3e50;
        }
        .axes-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .axes-legend div {
            margin: 2px 0;
        }
        #staticViewer {
            border-bottom: 2px solid #3498db;
        }
        .view-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .view-controls button {
            padding: 5px 10px;
            margin: 2px;
            font-size: 12px;
        }
        .display-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
        }
        .checkbox-group label {
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="viewer-container" id="staticViewer">
                <div class="viewer-title">é™æ€ç›¸å¯¹ä½ç½®</div>
                <div class="view-controls">
                    <button onclick="setView('top', 'static')">ä¿¯è§†</button>
                    <button onclick="setView('front', 'static')">å‰è§†</button>
                    <button onclick="setView('side', 'static')">ä¾§è§†</button>
                    <button onclick="setView('iso', 'static')">3D</button>
                </div>
                <div class="axes-legend">
                    <div style="color: #ff0000;">â— Xè½´ (å‰/çº¢)</div>
                    <div style="color: #00ff00;">â— Yè½´ (å³/ç»¿)</div>
                    <div style="color: #0000ff;">â— Zè½´ (ä¸Š/è“)</div>
                </div>
            </div>
            <div class="viewer-container" id="animationViewer">
                <div class="viewer-title">æ—‹è½¬åŠ¨ç”»</div>
                <div class="view-controls">
                    <button onclick="setView('top', 'anim')">ä¿¯è§†</button>
                    <button onclick="setView('front', 'anim')">å‰è§†</button>
                    <button onclick="setView('side', 'anim')">ä¾§è§†</button>
                    <button onclick="setView('iso', 'anim')">3D</button>
                </div>
                <div class="display-controls">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showGrid" onchange="toggleDisplayOptions()">
                        <label for="showGrid">æ˜¾ç¤ºç½‘æ ¼</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showAxes" onchange="toggleDisplayOptions()">
                        <label for="showAxes">æ˜¾ç¤ºåæ ‡è½´</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showIMU" onchange="toggleDisplayOptions()">
                        <label for="showIMU">æ˜¾ç¤ºIMU</label>
                    </div>
                </div>
                <div class="controls">
                    <div class="button-group">
                        <button id="playBtn" disabled>â–¶ æ’­æ”¾</button>
                        <button id="pauseBtn" disabled>â¸ æš‚åœ</button>
                        <button id="resetBtn" disabled>â†º é‡ç½®</button>
                        <div class="time-display">
                            æ—¶é—´: <span id="currentTime">0.000</span>s
                        </div>
                    </div>
                    <div class="slider-container">
                        <span>0s</span>
                        <input type="range" class="time-slider" id="timeSlider" min="0" max="100" value="0" disabled>
                        <span id="maxTime">0s</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <h2>IMU-é´å­å§¿æ€å¯è§†åŒ–</h2>
            
            <div class="section">
                <h3>ğŸ“ æ¨¡å‹å’Œæ•°æ®å¯¼å…¥</h3>
                <div>
                    <label>é´å­æ¨¡å‹ (STLæ ¼å¼):</label>
                    <input type="file" id="stlInput" accept=".stl">
                </div>
                <div>
                    <label>IMUæ•°æ® (CSVæ ¼å¼):</label>
                    <input type="file" id="csvInput" accept=".csv,.txt">
                </div>
            </div>
            
            <div class="section">
                <h3>ğŸ”„ STLæ¨¡å‹æ—‹è½¬è°ƒæ•´</h3>
                <div class="slider-controls">
                    <div class="slider-group">
                        <label>Xè½´æ—‹è½¬: <span id="stlRotXValue">0</span>Â°</label>
                        <input type="range" id="stlRotX" min="-180" max="180" value="0" step="1" oninput="updateSTLRotationPreview()">
                    </div>
                    <div class="slider-group">
                        <label>Yè½´æ—‹è½¬: <span id="stlRotYValue">0</span>Â°</label>
                        <input type="range" id="stlRotY" min="-180" max="180" value="0" step="1" oninput="updateSTLRotationPreview()">
                    </div>
                    <div class="slider-group">
                        <label>Zè½´æ—‹è½¬: <span id="stlRotZValue">0</span>Â°</label>
                        <input type="range" id="stlRotZ" min="-180" max="180" value="0" step="1" oninput="updateSTLRotationPreview()">
                    </div>
                    <button onclick="resetSTLRotation()" style="margin-top: 10px; width: 100%;">é‡ç½®æ—‹è½¬</button>
                </div>
            </div>
            
            <div class="section">
                <h3>ğŸ”§ IMUç›¸å¯¹ä½ç½®è®¾ç½®ï¼ˆä¸–ç•Œåæ ‡ç³»ï¼‰</h3>
                <div class="transform-inputs">
                    <div class="input-group">
                        <label>å¹³ç§» X (mm)</label>
                        <input type="number" id="transX" value="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>å¹³ç§» Y (mm)</label>
                        <input type="number" id="transY" value="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>å¹³ç§» Z (mm)</label>
                        <input type="number" id="transZ" value="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>æ—‹è½¬ X (Â°)</label>
                        <input type="number" id="rotX" value="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>æ—‹è½¬ Y (Â°)</label>
                        <input type="number" id="rotY" value="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>æ—‹è½¬ Z (Â°)</label>
                        <input type="number" id="rotZ" value="0" step="1">
                    </div>
                </div>
                <button onclick="updateIMUPosition()" style="margin-top: 10px; width: 100%;">åº”ç”¨ä½ç½®è®¾ç½®</button>
            </div>
            
            <div class="section" id="dataInfo" style="display: none;">
                <h3>ğŸ“Š æ•°æ®ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">æ•°æ®ç‚¹æ•°</div>
                        <div class="info-value" id="dataPoints">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é‡‡æ ·ç‡</div>
                        <div class="info-value" id="sampleRate">0 Hz</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ€»æ—¶é•¿</div>
                        <div class="info-value" id="duration">0s</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å½“å‰å¸§</div>
                        <div class="info-value" id="currentFrame">0</div>
                    </div>
                </div>
            </div>
            
            <div class="section" id="angleInfo" style="display: none;">
                <h3>ğŸ“ å½“å‰æ¬§æ‹‰è§’</h3>
                <h4 style="font-size: 14px; margin: 10px 0 5px 0;">ç»å¯¹æ¬§æ‹‰è§’</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Roll (Xè½´)</div>
                        <div class="info-value" id="absRoll">0.00Â°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Pitch (Yè½´)</div>
                        <div class="info-value" id="absPitch">0.00Â°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Yaw (Zè½´)</div>
                        <div class="info-value" id="absYaw">0.00Â°</div>
                    </div>
                </div>
                <h4 style="font-size: 14px; margin: 15px 0 5px 0;">ç›¸å¯¹æ¬§æ‹‰è§’ï¼ˆç›¸å¯¹åˆå§‹å§¿æ€ï¼‰</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Roll (Xè½´)</div>
                        <div class="info-value" id="relRoll">0.00Â°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Pitch (Yè½´)</div>
                        <div class="info-value" id="relPitch">0.00Â°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Yaw (Zè½´)</div>
                        <div class="info-value" id="relYaw">0.00Â°</div>
                    </div>
                </div>
            </div>
            
            <div class="section" id="chartSection" style="display: none;">
                <h3>ğŸ“ˆ æ¬§æ‹‰è§’å˜åŒ–æ›²çº¿</h3>
                <div class="chart-container">
                    <canvas id="angleChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let staticScene, staticCamera, staticRenderer;
        let animScene, animCamera, animRenderer;
        let bootModel = null;
        let imuBox1, imuBox2;
        let bootGroup1, bootGroup2;
        let imuData = [];
        let currentIndex = 0;
        let isPlaying = false;
        let angleChart = null;
        let initialAngles = null;
        let bootHeight = 150; // é»˜è®¤é´å­é«˜åº¦150mm
        
        // åŠ¨ç”»åœºæ™¯ä¸­çš„æ˜¾ç¤ºå…ƒç´ 
        let animGrid, animAxes;

        // é¼ æ ‡æ§åˆ¶
        let mouseStates = {
            static: { down: false, x: 0, y: 0, angleX: 0, angleY: -90, distance: 400 },
            anim: { down: false, x: 0, y: 0, angleX: 0, angleY: -90, distance: 400 }
        };

        // IMUç›¸å¯¹ä½ç½®å‚æ•°
        let imuTransform = {
            position: { x: 0, y: 0, z: 0 },
            rotation: { x: 0, y: 0, z: 0 }
        };

        // STLæ¨¡å‹æ—‹è½¬å‚æ•°
        let stlRotation = {
            x: 0,
            y: 0,
            z: 0
        };

        // åˆå§‹åŒ–åœºæ™¯
        function initScenes() {
            // é™æ€åœºæ™¯
            const staticContainer = document.getElementById('staticViewer');
            staticScene = new THREE.Scene();
            staticScene.background = new THREE.Color(0xf5f5f5);
            
            staticCamera = new THREE.PerspectiveCamera(
                50,
                staticContainer.offsetWidth / staticContainer.offsetHeight,
                0.1,
                2000
            );
            
            staticRenderer = new THREE.WebGLRenderer({ antialias: true });
            staticRenderer.setSize(staticContainer.offsetWidth, staticContainer.offsetHeight);
            staticRenderer.shadowMap.enabled = true;
            staticContainer.appendChild(staticRenderer.domElement);
            
            // åŠ¨ç”»åœºæ™¯
            const animContainer = document.getElementById('animationViewer');
            animScene = new THREE.Scene();
            animScene.background = new THREE.Color(0xf0f0f0);
            
            animCamera = new THREE.PerspectiveCamera(
                50,
                animContainer.offsetWidth / animContainer.offsetHeight,
                0.1,
                2000
            );
            
            animRenderer = new THREE.WebGLRenderer({ antialias: true });
            animRenderer.setSize(animContainer.offsetWidth, animContainer.offsetHeight);
            animRenderer.shadowMap.enabled = true;
            animContainer.appendChild(animRenderer.domElement);
            
            // æ·»åŠ å…‰ç…§
            [staticScene, animScene].forEach(scene => {
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.4);
                directionalLight1.position.set(10, 20, 10);
                directionalLight1.castShadow = true;
                scene.add(directionalLight1);
                
                const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.2);
                directionalLight2.position.set(-10, 20, -10);
                scene.add(directionalLight2);
            });
            
            // æ·»åŠ ç½‘æ ¼ï¼ˆXYå¹³é¢ï¼‰
            const gridHelper1 = new THREE.GridHelper(400, 40, 0x888888, 0xcccccc);
            gridHelper1.rotateX(Math.PI / 2); // æ—‹è½¬åˆ°XYå¹³é¢
            staticScene.add(gridHelper1);
            
            animGrid = new THREE.GridHelper(400, 40, 0x888888, 0xcccccc);
            animGrid.rotateX(Math.PI / 2); // æ—‹è½¬åˆ°XYå¹³é¢
            animGrid.visible = false; // é»˜è®¤éšè—
            animScene.add(animGrid);
            
            // æ·»åŠ åæ ‡è½´
            const axes1 = new THREE.AxesHelper(150);
            staticScene.add(axes1);
            
            animAxes = new THREE.AxesHelper(150);
            animAxes.visible = false; // é»˜è®¤éšè—
            animScene.add(animAxes);
            
            // åˆ›å»ºé´å­ç»„
            bootGroup1 = new THREE.Group();
            bootGroup2 = new THREE.Group();
            staticScene.add(bootGroup1);
            animScene.add(bootGroup2);
            
            // åˆ›å»ºIMU
            createIMUs();
            
            // è®¾ç½®ç›¸æœºä½ç½®ï¼ˆä»ä¸Šå¾€ä¸‹çœ‹ï¼‰
            updateCameraPositions();
            
            // é¼ æ ‡äº‹ä»¶
            setupMouseControls(staticRenderer.domElement, 'static');
            setupMouseControls(animRenderer.domElement, 'anim');
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', onWindowResize);
            
            animate();
        }

        // åˆ›å»ºIMUæ¨¡å‹
        function createIMUs() {
            // IMUå›ºå®šå°ºå¯¸ï¼šXå’ŒYè½´60mmï¼ŒZè½´20mm
            const geometry = new THREE.BoxGeometry(60, 60, 20);
            const material = new THREE.MeshPhongMaterial({
                color: 0x2ecc71,
                transparent: true,
                opacity: 0.8
            });
            
            // é™æ€åœºæ™¯çš„IMUï¼ˆåˆå§‹ä½ç½®åœ¨åŸç‚¹ï¼‰
            imuBox1 = new THREE.Mesh(geometry, material);
            imuBox1.castShadow = true;
            imuBox1.receiveShadow = true;
            
            const edges1 = new THREE.EdgesGeometry(geometry);
            const edgeMaterial1 = new THREE.LineBasicMaterial({ color: 0x000000 });
            const wireframe1 = new THREE.LineSegments(edges1, edgeMaterial1);
            imuBox1.add(wireframe1);
            
            const localAxes1 = new THREE.AxesHelper(40);
            imuBox1.add(localAxes1);
            
            bootGroup1.add(imuBox1);
            
            // åŠ¨ç”»åœºæ™¯çš„IMU
            imuBox2 = new THREE.Mesh(geometry.clone(), material.clone());
            imuBox2.castShadow = true;
            imuBox2.receiveShadow = true;
            imuBox2.visible = false; // é»˜è®¤éšè—
            
            const edges2 = new THREE.EdgesGeometry(geometry);
            const edgeMaterial2 = new THREE.LineBasicMaterial({ color: 0x000000 });
            const wireframe2 = new THREE.LineSegments(edges2, edgeMaterial2);
            imuBox2.add(wireframe2);
            
            const localAxes2 = new THREE.AxesHelper(40);
            imuBox2.add(localAxes2);
            
            bootGroup2.add(imuBox2);
            
            updateIMUPosition();
        }

        // åˆ‡æ¢æ˜¾ç¤ºé€‰é¡¹
        function toggleDisplayOptions() {
            const showGrid = document.getElementById('showGrid').checked;
            const showAxes = document.getElementById('showAxes').checked;
            const showIMU = document.getElementById('showIMU').checked;
            
            if (animGrid) animGrid.visible = showGrid;
            if (animAxes) animAxes.visible = showAxes;
            if (imuBox2) imuBox2.visible = showIMU;
        }

        // å®æ—¶æ›´æ–°STLæ¨¡å‹æ—‹è½¬é¢„è§ˆ
        function updateSTLRotationPreview() {
            // æ›´æ–°æ˜¾ç¤ºå€¼
            document.getElementById('stlRotXValue').textContent = document.getElementById('stlRotX').value;
            document.getElementById('stlRotYValue').textContent = document.getElementById('stlRotY').value;
            document.getElementById('stlRotZValue').textContent = document.getElementById('stlRotZ').value;
            
            // ç«‹å³åº”ç”¨æ—‹è½¬
            updateSTLRotation();
        }

        // æ›´æ–°STLæ¨¡å‹æ—‹è½¬
        function updateSTLRotation() {
            stlRotation.x = parseFloat(document.getElementById('stlRotX').value) * Math.PI / 180;
            stlRotation.y = parseFloat(document.getElementById('stlRotY').value) * Math.PI / 180;
            stlRotation.z = parseFloat(document.getElementById('stlRotZ').value) * Math.PI / 180;
            
            // æ›´æ–°ä¸¤ä¸ªåœºæ™¯ä¸­çš„é´å­æ—‹è½¬
            [bootGroup1, bootGroup2].forEach(group => {
                const boot = group.children.find(child => child.name === 'boot');
                if (boot && boot.userData.baseRotation) {
                    boot.rotation.x = boot.userData.baseRotation.x + stlRotation.x;
                    boot.rotation.y = boot.userData.baseRotation.y + stlRotation.y;
                    boot.rotation.z = boot.userData.baseRotation.z + stlRotation.z;
                }
            });
        }

        // é‡ç½®STLæ—‹è½¬
        function resetSTLRotation() {
            document.getElementById('stlRotX').value = 0;
            document.getElementById('stlRotY').value = 0;
            document.getElementById('stlRotZ').value = 0;
            updateSTLRotationPreview();
        }

        // æ›´æ–°IMUä½ç½®ï¼ˆä½¿ç”¨ä¸–ç•Œåæ ‡ç³»ï¼‰
        function updateIMUPosition() {
            imuTransform.position.x = parseFloat(document.getElementById('transX').value);
            imuTransform.position.y = parseFloat(document.getElementById('transY').value);
            imuTransform.position.z = parseFloat(document.getElementById('transZ').value);
            imuTransform.rotation.x = parseFloat(document.getElementById('rotX').value) * Math.PI / 180;
            imuTransform.rotation.y = parseFloat(document.getElementById('rotY').value) * Math.PI / 180;
            imuTransform.rotation.z = parseFloat(document.getElementById('rotZ').value) * Math.PI / 180;
            
            [imuBox1, imuBox2].forEach(imu => {
                if (imu) {
                    imu.position.set(
                        imuTransform.position.x,
                        imuTransform.position.y,
                        imuTransform.position.z
                    );
                    imu.rotation.set(
                        imuTransform.rotation.x,
                        imuTransform.rotation.y,
                        imuTransform.rotation.z
                    );
                }
            });
        }

        // è®¾ç½®è§†è§’
        function setView(view, type) {
            let distance = mouseStates[type].distance;
            switch(view) {
                case 'top':
                    mouseStates[type].angleX = 0;
                    mouseStates[type].angleY = -90;
                    break;
                case 'front':
                    mouseStates[type].angleX = 0;
                    mouseStates[type].angleY = 0;
                    break;
                case 'side':
                    mouseStates[type].angleX = 90;
                    mouseStates[type].angleY = 0;
                    break;
                case 'iso':
                    mouseStates[type].angleX = 45;
                    mouseStates[type].angleY = -45;
                    break;
            }
            updateCameraPositions();
        }

        // è®¾ç½®é¼ æ ‡æ§åˆ¶
        function setupMouseControls(element, type) {
            element.addEventListener('mousedown', (e) => onMouseDown(e, type));
            element.addEventListener('mouseup', () => onMouseUp(type));
            element.addEventListener('mousemove', (e) => onMouseMove(e, type));
            element.addEventListener('mouseleave', () => onMouseUp(type));
            element.addEventListener('wheel', (e) => onWheel(e, type), { passive: false });
        }

        function onMouseDown(event, type) {
            mouseStates[type].down = true;
            mouseStates[type].x = event.clientX;
            mouseStates[type].y = event.clientY;
        }

        function onMouseUp(type) {
            mouseStates[type].down = false;
        }

        function onMouseMove(event, type) {
            if (!mouseStates[type].down) return;
            
            const deltaX = event.clientX - mouseStates[type].x;
            const deltaY = event.clientY - mouseStates[type].y;
            
            mouseStates[type].angleX += deltaX * 0.5;
            mouseStates[type].angleY = Math.max(-179, Math.min(-1, mouseStates[type].angleY - deltaY * 0.5));
            
            mouseStates[type].x = event.clientX;
            mouseStates[type].y = event.clientY;
            
            updateCameraPositions();
        }

        function onWheel(event, type) {
            event.preventDefault();
            mouseStates[type].distance = Math.max(50, Math.min(1000, mouseStates[type].distance + event.deltaY * 0.2));
            updateCameraPositions();
        }

        function updateCameraPositions() {
            // æ›´æ–°é™æ€ç›¸æœº
            const staticState = mouseStates.static;
            const radX1 = staticState.angleX * Math.PI / 180;
            const radY1 = staticState.angleY * Math.PI / 180;
            
            staticCamera.position.x = staticState.distance * Math.sin(-radY1) * Math.sin(radX1);
            staticCamera.position.y = staticState.distance * Math.sin(-radY1) * Math.cos(radX1);
            staticCamera.position.z = staticState.distance * Math.cos(-radY1);
            staticCamera.lookAt(0, 0, 0);
            
            // æ›´æ–°åŠ¨ç”»ç›¸æœº
            const animState = mouseStates.anim;
            const radX2 = animState.angleX * Math.PI / 180;
            const radY2 = animState.angleY * Math.PI / 180;
            
            animCamera.position.x = animState.distance * Math.sin(-radY2) * Math.sin(radX2);
            animCamera.position.y = animState.distance * Math.sin(-radY2) * Math.cos(radX2);
            animCamera.position.z = animState.distance * Math.cos(-radY2);
            animCamera.lookAt(0, 0, 0);
        }

        function onWindowResize() {
            const staticContainer = document.getElementById('staticViewer');
            const animContainer = document.getElementById('animationViewer');
            
            staticCamera.aspect = staticContainer.offsetWidth / staticContainer.offsetHeight;
            staticCamera.updateProjectionMatrix();
            staticRenderer.setSize(staticContainer.offsetWidth, staticContainer.offsetHeight);
            
            animCamera.aspect = animContainer.offsetWidth / animContainer.offsetHeight;
            animCamera.updateProjectionMatrix();
            animRenderer.setSize(animContainer.offsetWidth, animContainer.offsetHeight);
        }

        // æ–‡ä»¶åŠ è½½
        document.getElementById('stlInput').addEventListener('change', loadSTL);
        document.getElementById('csvInput').addEventListener('change', loadCSV);

        function loadSTL(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // é‡ç½®STLæ—‹è½¬æ»‘å—
            resetSTLRotation();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const loader = new THREE.STLLoader();
                const geometry = loader.parse(e.target.result);
                
                // è®¡ç®—é´å­å°ºå¯¸
                geometry.computeBoundingBox();
                const box = geometry.boundingBox;
                
                // ä¿æŒSTLæ–‡ä»¶çš„åŸå§‹åæ ‡ç³»å’Œä½ç½®
                // ä¸è¿›è¡Œä»»ä½•è‡ªåŠ¨æ—‹è½¬æˆ–ä½ç½®è°ƒæ•´
                // è®¡ç®—æ¨¡å‹å°ºå¯¸ï¼Œä½†ä¸æ”¹å˜æ–¹å‘
                const sizeX = box.max.x - box.min.x;
                const sizeY = box.max.y - box.min.y;
                const sizeZ = box.max.z - box.min.z;
                
                // ä½¿ç”¨Zè½´ä½œä¸ºé«˜åº¦ï¼ˆä¿æŒåŸå§‹åæ ‡ç³»ï¼‰
                bootHeight = sizeZ;
                
                // åˆ›å»ºé´å­æ¨¡å‹
                const material = new THREE.MeshPhongMaterial({
                    color: 0x808080,  // ç°è‰²
                    specular: 0x222222,
                    shininess: 25
                });
                
                // æ¸…é™¤æ—§æ¨¡å‹
                [bootGroup1, bootGroup2].forEach(group => {
                    const oldBoot = group.children.find(child => child.name === 'boot');
                    if (oldBoot) group.remove(oldBoot);
                });
                
                // æ·»åŠ æ–°æ¨¡å‹ - ä¿æŒåŸå§‹ä½ç½®å’Œæ–¹å‘
                const boot1 = new THREE.Mesh(geometry, material);
                boot1.name = 'boot';
                boot1.castShadow = true;
                boot1.receiveShadow = true;
                
                // ä¿å­˜åŸºç¡€æ—‹è½¬ï¼ˆåˆå§‹ä¸º0ï¼‰
                boot1.userData.baseRotation = new THREE.Vector3(0, 0, 0);
                
                // åº”ç”¨ç”¨æˆ·è®¾ç½®çš„æ—‹è½¬
                boot1.rotation.x = stlRotation.x;
                boot1.rotation.y = stlRotation.y;
                boot1.rotation.z = stlRotation.z;
                
                bootGroup1.add(boot1);
                
                const boot2 = new THREE.Mesh(geometry.clone(), material.clone());
                boot2.name = 'boot';
                boot2.castShadow = true;
                boot2.receiveShadow = true;
                boot2.userData.baseRotation = new THREE.Vector3(0, 0, 0);
                boot2.rotation.copy(boot1.rotation);
                
                bootGroup2.add(boot2);
            };
            reader.readAsArrayBuffer(file);
        }

        function loadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseData(e.target.result);
            };
            reader.readAsText(file);
        }

        // è§£ææ•°æ®
        function parseData(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            imuData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = isNaN(values[index]) ? values[index] : parseFloat(values[index]);
                });
                
                imuData.push(row);
            }
            
            // ä¿å­˜åˆå§‹è§’åº¦
            if (imuData.length > 0) {
                initialAngles = {
                    x: imuData[0]['angleX(Â°)'] || 0,
                    y: imuData[0]['angleY(Â°)'] || 0,
                    z: imuData[0]['angleZ(Â°)'] || 0
                };
            }
            
            // æ˜¾ç¤ºæ•°æ®ä¿¡æ¯
            displayDataInfo();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // å¯ç”¨æ§åˆ¶æŒ‰é’®å’Œæ»‘å—
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('timeSlider').disabled = false;
            
            // è®¾ç½®æ»‘å—èŒƒå›´
            document.getElementById('timeSlider').max = imuData.length - 1;
            
            // é‡ç½®åˆ°ç¬¬ä¸€å¸§
            currentIndex = 0;
            updateVisualization();
        }

        // æ˜¾ç¤ºæ•°æ®ä¿¡æ¯
        function displayDataInfo() {
            document.getElementById('dataInfo').style.display = 'block';
            document.getElementById('angleInfo').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            
            document.getElementById('dataPoints').textContent = imuData.length;
            
            if (imuData.length > 1) {
                const timeDiff = imuData[1].timestamp - imuData[0].timestamp;
                const sampleRate = 1000 / timeDiff;
                document.getElementById('sampleRate').textContent = sampleRate.toFixed(1) + ' Hz';
                
                const totalTime = (imuData[imuData.length - 1].timestamp - imuData[0].timestamp) / 1000;
                document.getElementById('duration').textContent = totalTime.toFixed(2) + 's';
                document.getElementById('maxTime').textContent = totalTime.toFixed(1) + 's';
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('angleChart').getContext('2d');
            
            if (angleChart) {
                angleChart.destroy();
            }
            
            const time = imuData.map((d, i) => i);
            const angleX = imuData.map(d => d['angleX(Â°)'] - initialAngles.x);
            const angleY = imuData.map(d => d['angleY(Â°)'] - initialAngles.y);
            const angleZ = imuData.map(d => d['angleZ(Â°)'] - initialAngles.z);
            
            angleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: time,
                    datasets: [
                        {
                            label: 'Roll (X)',
                            data: angleX,
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Pitch (Y)',
                            data: angleY,
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Yaw (Z)',
                            data: angleZ,
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'ç›¸å¯¹æ¬§æ‹‰è§’å˜åŒ–'
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'è§’åº¦ (Â°)'
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å¯è§†åŒ–
        function updateVisualization() {
            if (currentIndex >= imuData.length) {
                currentIndex = 0;
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
            }
            
            const data = imuData[currentIndex];
            
            // è·å–æ¬§æ‹‰è§’ï¼ˆæ³¨æ„åæ ‡ç³»è½¬æ¢ï¼‰
            const roll = (data['angleX(Â°)'] || 0) * Math.PI / 180;
            const pitch = (data['angleY(Â°)'] || 0) * Math.PI / 180;
            const yaw = (data['angleZ(Â°)'] || 0) * Math.PI / 180;
            
            // æ›´æ–°åŠ¨ç”»åœºæ™¯ä¸­çš„é´å­ç»„æ—‹è½¬
            bootGroup2.rotation.set(roll, pitch, yaw);
            
            // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
            const currentTime = (data.timestamp - imuData[0].timestamp) / 1000;
            document.getElementById('currentTime').textContent = currentTime.toFixed(3);
            document.getElementById('currentFrame').textContent = currentIndex;
            
            // æ›´æ–°æ»‘å—ä½ç½®
            document.getElementById('timeSlider').value = currentIndex;
            
            // ç»å¯¹æ¬§æ‹‰è§’
            document.getElementById('absRoll').textContent = (data['angleX(Â°)'] || 0).toFixed(2) + 'Â°';
            document.getElementById('absPitch').textContent = (data['angleY(Â°)'] || 0).toFixed(2) + 'Â°';
            document.getElementById('absYaw').textContent = (data['angleZ(Â°)'] || 0).toFixed(2) + 'Â°';
            
            // ç›¸å¯¹æ¬§æ‹‰è§’
            document.getElementById('relRoll').textContent = ((data['angleX(Â°)'] || 0) - initialAngles.x).toFixed(2) + 'Â°';
            document.getElementById('relPitch').textContent = ((data['angleY(Â°)'] || 0) - initialAngles.y).toFixed(2) + 'Â°';
            document.getElementById('relYaw').textContent = ((data['angleZ(Â°)'] || 0) - initialAngles.z).toFixed(2) + 'Â°';
            
            // æ›´æ–°å›¾è¡¨å½“å‰ä½ç½®
            if (angleChart) {
                angleChart.options.plugins.annotation = {
                    annotations: {
                        line1: {
                            type: 'line',
                            xMin: currentIndex,
                            xMax: currentIndex,
                            borderColor: 'rgba(0, 0, 0, 0.5)',
                            borderWidth: 2
                        }
                    }
                };
                angleChart.update('none');
            }
        }

        // æ§åˆ¶æŒ‰é’®
        document.getElementById('playBtn').addEventListener('click', play);
        document.getElementById('pauseBtn').addEventListener('click', pause);
        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('timeSlider').addEventListener('input', onSliderChange);

        function play() {
            isPlaying = true;
            document.getElementById('playBtn').textContent = 'â¸ æš‚åœ';
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
        }

        function reset() {
            currentIndex = 0;
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
            updateVisualization();
        }

        function onSliderChange() {
            currentIndex = parseInt(document.getElementById('timeSlider').value);
            updateVisualization();
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            if (isPlaying && imuData.length > 0) {
                currentIndex++;
                updateVisualization();
            }
            
            staticRenderer.render(staticScene, staticCamera);
            animRenderer.render(animScene, animCamera);
        }

        // åˆå§‹åŒ–
        initScenes();
    </script>
</body>
</html>